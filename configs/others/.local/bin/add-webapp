#!/usr/bin/env bash
set -euo pipefail

APPDIR="${XDG_DATA_HOME:-"$HOME/.local/share"}/applications"
ICONDIR="${XDG_DATA_HOME:-"$HOME/.local/share"}/icons/webapps"
TMPDIR="$(mktemp -d)"
trap 'rm -rf "$TMPDIR"' EXIT

usage(){
  cat <<EOF
Usage:
  add-webapp [options] "Name" "URL"

Options:
  -i, --icon PATH_OR_URL    Local icon file or remote icon URL to download (optional)
  -b, --browser CMD         Browser command to use (required if BROWSER not set)
  -h, --help                Show this help
EOF
}

err(){ printf 'Error: %s\n' "$*" >&2; exit 1; }
log(){ printf '%s\n' "$*"; }
ensure_cmd(){ command -v "$1" >/dev/null 2>&1; }

sanitize(){
  printf '%s' "${1:-}" \
    | tr '[:upper:]' '[:lower:]' \
    | sed -E 's/[^a-z0-9._ -]/-/g' \
    | tr ' ' '-'
}

is_url(){ [[ "${1:-}" =~ ^https?:// ]] ; }

ensure_cmd curl || err "This script requires 'curl'."

download_to(){
  curl -fsSL --location "$1" -o "$2"
}

install_icon(){
  local safe="${1:-}"; local choice="${2:-}"; local out
  [ -n "$safe" ] || err "internal error: install_icon called without safe name"
  mkdir -p "$ICONDIR"
  out="$ICONDIR/${safe}.png"
  case "$choice" in
    local:*)
      local src="${choice#local:}"
      [ -f "$src" ] || err "Local icon not found: $src"
      cp -f "$src" "$out"
      ;;
    url:*)
      download_to "${choice#url:}" "$out" || err "Failed to download icon"
      ;;
    "")
      return 0
      ;;
    *)
      err "Invalid icon choice"
      ;;
  esac
  [ -s "$out" ] || err "Icon file is empty: $out"
  printf '%s' "$out"
}

write_desktop(){
  local name="${1:-}" safe="${2:-}" url="${3:-}" browser="${4:-}" icon="${5:-}" desktop exec_line
  [ -n "$name" ] || err "internal error: write_desktop missing name"
  [ -n "$safe" ] || err "internal error: write_desktop missing safe"
  [ -n "$url" ] || err "internal error: write_desktop missing url"
  [ -n "$browser" ] || err "internal error: write_desktop missing browser"
  mkdir -p "$APPDIR"
  desktop="$APPDIR/${safe}.desktop"
  if printf '%s\n' "$browser" | grep -q 'xdg-open'; then
    exec_line="$browser $url"
  else
    exec_line="$browser --app=$url"
  fi
  cat > "$desktop" <<EOF
[Desktop Entry]
Name=$name
GenericName=Web App
Exec=$exec_line
Terminal=false
Type=Application
Categories=Network;WebBrowser;
EOF
  [ -n "$icon" ] && printf 'Icon=%s\n' "$icon" >> "$desktop"
  chmod 644 "$desktop"
  log "Created: $desktop"
}

# parse options
ICON_FLAG=""; BROWSER_OVERRIDE=""
while [ $# -gt 0 ]; do
  case "$1" in
    -i|--icon) ICON_FLAG="$2"; shift 2 ;;
    -b|--browser) BROWSER_OVERRIDE="$2"; shift 2 ;;
    -h|--help) usage; exit 0 ;;
    --) shift; break ;;
    -*) err "Unknown option: $1" ;;
    *) break ;;
  esac
done

[ $# -ge 2 ] || { usage; err "Expected: Name and URL"; }
NAME="$1"; URL="$2"
[ -n "$NAME" ] || err "Name is empty"
[ -n "$URL" ] || err "URL is empty"
is_url "$URL" || err "URL must start with http:// or https://"

SAFE="$(sanitize "$NAME")"
[ -n "$SAFE" ] || err "Sanitization produced empty id; pick a different Name"

browser_cmd="$BROWSER_OVERRIDE"
if [ -z "$browser_cmd" ]; then browser_cmd="${BROWSER:-}"; fi
[ -n "$browser_cmd" ] || err "No browser specified; use -b/--browser or set BROWSER env."

ICON_PATH=""
if [ -n "$ICON_FLAG" ]; then
  if is_url "$ICON_FLAG"; then
    ICON_PATH="$(install_icon "$SAFE" "url:$ICON_FLAG")"
  else
    ICON_PATH="$(install_icon "$SAFE" "local:$ICON_FLAG")"
  fi
fi

write_desktop "$NAME" "$SAFE" "$URL" "$browser_cmd" "$ICON_PATH"

if ensure_cmd update-desktop-database; then
  update-desktop-database "${APPDIR}" >/dev/null 2>&1 || true
fi

log "Done."
